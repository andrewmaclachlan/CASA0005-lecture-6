---
title: "Spatial analysis of public health data"
subtitle: "Point Pattern Analysis"
author: "Andy MacLachlan + Laura Sheppard"
output:
  xaringan::moon_reader:
    css: ["custom.css", "default", "rladies", "rladies-fonts"]    
    lib_dir: libs
    includes:
      in_header: [assets/header.html]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    seal: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

```{r xaringan-all, echo=FALSE}
library(countdown)
library(xaringan)
library(xaringanExtra)
library(knitr)

hook_source <- knitr::knit_hooks$get('source')
knitr::knit_hooks$set(source = function(x, options) {
  x <- stringr::str_replace(x, "^[[:blank:]]?([^*].+?)[[:blank:]]*#<<[[:blank:]]*$", "*\\1")
  hook_source(x, options)
})

xaringanExtra::use_broadcast()
xaringanExtra::use_freezeframe()
xaringanExtra::use_scribble()
#xaringanExtra::use_slide_tone()
xaringanExtra::use_search(show_icon = TRUE)
xaringanExtra::use_freezeframe()
xaringanExtra::use_clipboard()
xaringanExtra::use_tile_view()
xaringanExtra::use_panelset()
xaringanExtra::use_editable(expires = 1)
xaringanExtra::use_fit_screen()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)
```

class: inverse, center, title-slide, middle

<style>
.title-slide .remark-slide-number {
  display: none;
}
</style>

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(fontawesome)
```

# Spatial analysis of public health data

### Point Pattern Analysis

### 21/02/2022 (updated: `r format(Sys.time(), "%d/%m/%Y")`)
.pull-left[### Andy 
`r fa("paper-plane", fill = "white")`[a.maclachlan@ucl.ac.uk](mailto:a.maclachlan@ucl.ac.uk)
`r fa("twitter", fill = "white")`[andymaclachlan](https://twitter.com/andymaclachlan)
`r fa("github", fill = "white")`[andrewmaclachlan](https://github.com/andrewmaclachlan)]

.pull-right[### Laura
`r fa("paper-plane", fill = "white")`[a.maclachlan@ucl.ac.uk](mailto:a.maclachlan@ucl.ac.uk)
`r fa("twitter", fill = "white")`[andymaclachlan](https://twitter.com/andymaclachlan)
`r fa("github", fill = "white")`[andrewmaclachlan](https://github.com/andrewmaclachlan)]


`r fa("map-marker", fill = "white")`[Centre for Advanced Spatial Analysis, UCL](https://www.ucl.ac.uk/bartlett/casa/)

Slide acknowledgement: [Professor Adam Dennett](https://twitter.com/adam_dennett)

<a href="https://github.com/andrewmaclachlan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

---
```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "img/casa_logo.jpg"
)
```

# About me

* Undergraduate in human geography, University of Sheffield + year abroad at the University of Wollongong

* MSc in Remote Sensing and GIS, University of Southampton 

* PhD in Geography and Environmental Science, University of Southampton / University of Western Australia "Earth Observation for Quantifying Urban Growth and its Application to Sustainable City Development"

* Teaching Fellow and now lecturer in The Barlett Centre for Advanced Spatial Analysis + lead our MSc in Smart Cities and Urban Analytics becoming Urban Spatial Science

* [Research:](https://scholar.google.com/citations?user=wLrJwyQAAAAJ&hl=en)
  * Geospatial tools / data for sustainable planning and environmental decision making 
  
* Teaching:
  * [Geographic Information Systems and Science](https://andrewmaclachlan.github.io/CASA0005repo/)
  * [Remotely Sensing Cities and Environments](https://andrewmaclachlan.github.io/CASA0023/)  
---
# About Laura


---

# How to use the lectures

- Slides are made with [xaringan](https://slides.yihui.org/xaringan/#1) `r emo::ji("speak")` shar-in-gen or [ʃæ.ˈriŋ.gæn]

- `r fa("search")` In the bottom left there is a search tool which will search all content of presentation

- Control + F will also search 

- Press enter to move to the next result 

- `r fa("pencil-alt")` In the top right let's you draw on the slides, although these aren't saved.

- Pressing the letter `o` (for overview) will allow you to see an overview of the whole presentation and go to a slide

- Alternatively just typing the slide number e.g. 10 on the website will take you to that slide

- Pressing alt+F will fit the slide to the screen, this is useful if you have resized the window and have another open - side by side. 

---

class: inverse, center, middle

# Slide and content acknowledgement: [Professor Adam Dennett](https://twitter.com/adam_dennett)

---
# Outline

.pull-left[
* The importance of pattern

* Patterns of categorical point data – Point Pattern Analysis
  * Quadrat Analysis
  * Ripley’s K
  * DBSCAN

* Patterns of spatially referenced continuous observations
  * Spatial autocorrelation
  * Defining near and distant things
  * Measuring spatial autocorrelation
    * Moran’s I
    * LISA

]

.pull-right[

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('img/pump.jpg')
```

.small[Broad street pump and John Snow pub. Source:[Hartford Courant](https://www.tribpub.com/gdpr/courant.com/)
]
]
???

Two halves: 

* Rapid overview of point pattern analysis
* Detecting spatial patterns - where are they
* Point data (or categorical data in space - lines / polygons)

* Spatially referenced observations - where regions of a map are similar = clustering of values = spatial autocorrelation. 
---

# The first (?) point pattern analysis 

### Dr John Snow

.pull-left[

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/Jon_Snow_Season.png')
```

.small[Jon Snow. Source: [Wikipedia](https://en.wikipedia.org/wiki/Jon_Snow_(character)
]
]

--

.pull-right[

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/John_Snow.jpg')
```

.small[John Snow. Source:[Wikipedia](https://en.wikipedia.org/wiki/John_Snow)
]
]

---

# What patterns show

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/cholera.png')
```

.small[Something in the water: the mythology of Snow’s map of cholera. Source:[Kenneth Field](https://www.esri.com/arcgis-blog/products/arcgis-pro/mapping/something-in-the-water-the-mythology-of-snows-map-of-cholera/)
]

???

John snow often attributed with identifying the outbreak at the broad street pump
Data was from mortality reports issued by the Registrar General Office not surveys
Snow wasn't responsible directly, but it contributed to the knowledge 
Snow also didn't event this mapping style - 1798 New York outbreak of Yellow fever - Valentine Seaman 
Second version of the map in 1855 had distance to pump - first voroni diagram 

---

# Spatial Epidemiology: Lung Cancer


```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/Gatrell.png')
```

.small[Spatial Point Pattern Analysis and its Application in Geographical Epidemiology. Source:[Gatrell et al.1996](https://www.jstor.org/stable/622936?seq=1#metadata_info_tab_contents)
]

???

* Similar methods 
* are the locations of lung cancer similar?
* Does the incinerator have any influence ?
---

# Spatial Epidemiology: Mortality

* Similar values might suggest there is something more going on
* Some sort of spatial influence
* Note the difference between spatially continuous and point data

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/Lorant.png')
```

.small[Deprivation and mortality: the implications of spatial autocorrelation for health resources allocation. Source:[Lornt et al.2001](https://reader.elsevier.com/reader/sd/pii/S0277953600004561?token=C5F23C3B005AE5E609482CE25240CBDC867C3A88C5D3E6DFA680F5DCA353B6799D0BD26BFDA6BE8E1A55E70684613D8E&originRegion=eu-west-1&originCreation=20220221114112)
]

---

# Quantifying Spatial Patterns

What is fixed?

.pull-left[

### Point Pattern Analysis

* Properties are fixed (e.g. binary - present or not)
* Discrete objects - present or not, binary, yes or no.
* Examples: fly tipping, stop and search, blue plaques, pharmacies 

Properties fixed, but **space (location - x,y)** can vary

]

.pull-right[

### Spatial Autocorrelation

* Space (e.g. the location of the spatial units - wards, boroughs etc) is fixed
* The values of the spatial units vary
* Where the values are similar we say they exhibit Spatial Autocorrelation 

Space is fixed, but **properties (values)** can vary

]

---

# Examples

* Location of blue plaques in London
* Question: Are the points clustered or are they random?

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/blue_plaques.png')
```

.small[Source:[CASA0005](https://andrewmaclachlan.github.io/CASA0005repo/detecting-spatial-patterns.html#)
]

---

# Examples

* Average GCSE point score 2014 per London ward
* Question: Are the values similar between certain wards?

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/average_GCSE.png')
```

.small[Source:[CASA0005](https://andrewmaclachlan.github.io/CASA0005repo/detecting-spatial-patterns.html#)
]

---
# From points to spatially continuous observations 1

* We can convert almost any point data into spatially continuous observations

### Questions
* Why should we never (or almost never) use count data (e.g. number of blue plaques per ward) for spatial autocorrelation measures?

* In what instance might we be able to use count data?

* Discuss in groups for 2 mins?

`r countdown(minutes=1, seconds =30, warn_when = 10, bottom=0, left="65%")`

---
# From points to spatially continuous observations 2

### Answers

* Summing the counts generates results that are dependent on the size of the spatial unit ...e.g...

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/grid_vs_tess_counts.svg')
```

.small[Count of individuals in each zonal unit. Note how an underlying point distribution can generate vastly different looking choropleth maps given different aggregation schemes. Source:[Intro to GIS and Spatial Analysis Manuel Gimond, 2022](https://mgimond.github.io/Spatial/pitfalls-to-avoid.html)]

---
# From points to spatially continuous observations 3

* In this case we could sum our counts and normalise then based on some sort of underling data - such as population. e.g...lung cancer rates or mortality rates 

Our code would look similar to this ...

```{r, eval=FALSE}
points_sf_joined <- LondonWardsMerged%>%
  st_join(BluePlaquesSub)%>%
  add_count(ward_name)%>%
  janitor::clean_names()%>%
  #calculate area
  mutate(area=st_area(.))%>%
  #then density of the points per ward
  mutate(density=n/area)%>%
  #select density and some other variables 
  dplyr::select(density, ward_name, gss_code, n, average_gcse_capped_point_scores_2014)
```

* Sometimes we can have "unstable rates" - where values are very small, consult [Coping with Unstable Rates](Gimond, 2022)
---
# From points to spatially continuous observations 4

### Answers

* An instance where it is ok to use counts is where the mapping units are spatially consistent --e.g. hexagons or Uber's H3 grid
* The variable spatial unit is removed

```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/hexagons.jpg')
```

.small[Source:[Thematic Mapping with Hexagons, ESRI 2015](https://www.esri.com/about/newsroom/insider/thematic-mapping-with-hexagons/)
]

---
# Take care! 

### Modifiable Areal Unit Problem

* Different aggregations will lead to:

  * Different outcomes
  
  * Uncomparable results 
  
```{r echo=FALSE, out.width='60%', fig.align='center'}
knitr::include_graphics('img/MAUP-Scale-Effect-1265x632.PNG')
```

.small[Source:[gisgeography](https://gisgeography.com/maup-modifiable-areal-unit-problem/)
]  
---
# Take care 2! 

If you have aggregated point data they can no longer be described as points...as [Gimond 2022 says](https://mgimond.github.io/Spatial/pitfalls-to-avoid.html#ecological-fallacy)

> "you might be tempted to state that there is a strong relationship between variables v1 and v2 at the individual level. But doing so leads to the ecological fallacy where the statistical relationship at one level of aggregation is (wrongly) assumed to hold at any other levels of aggregation (including at the individual level). In fact, all you can really say is that “at this level of aggregation, we observe a strong relationship between v1 and v2” and nothing more!"  

---

class: inverse, center, middle
# Now how do we calculate clustering and spatial autocorrelation...

---
